"use strict";!function(e){angular.module("pw.canvas-painter",[]),function(e){try{e=angular.module("pw.canvas-painter")}catch(t){e=angular.module("pw.canvas-painter",[])}e.run(["$templateCache",function(e){e.put("../templates/canvas.html",'<div class="pwCanvasPaint" style="position:relative"></div>')}])}(),function(e){try{e=angular.module("pw.canvas-painter")}catch(t){e=angular.module("pw.canvas-painter",[])}e.run(["$templateCache",function(e){e.put("../templates/color-selector.html",'<ul class="pwColorSelector"><li ng-repeat="color in colorList track by $index" class="pwColor" ng-class="{\'active\': (selectedColor === color)}" ng-style="{\'background-color\':color}" ng-click="setColor(color)"></li></ul>')}])}(),angular.module("pw.canvas-painter").directive("pwCanvas",["$window",function(t){return{restrict:"AE",scope:{options:"=",version:"="},templateUrl:"../templates/canvas.html",link:function(n,o){var a=!!("ontouchstart"in e),i=a?"touchstart":"mousedown",r=a?"touchmove":"mousemove",c=a?"touchend":"mouseup",l=n.options;if(l.canvasId=l.customCanvasId||"pwCanvasMain",l.tmpCanvasId=l.customCanvasId?l.canvasId+"Tmp":"pwCanvasTmp",l.width=l.width||400,l.height=l.height||300,l.backgroundColor=l.backgroundColor||"#fff",l.color=l.color||"#000",l.undoEnabled=l.undoEnabled||!1,l.opacity=l.opacity||.9,l.lineWidth=l.lineWidth||1,l.undo=l.undo||!1,l.imageSrc=l.imageSrc||!1,l.imageSrc){var s=new Image;s.onload=function(){p.drawImage(this,0,0)},s.src=l.imageSrc}if(l.undo){var u=[];n.$watch(function(){return u.length},function(e){n.version=e}),n.$watch("version",function(e){return 0>e?(n.version=0,void 0):e>=u.length?(n.version=u.length,void 0):(E(e),void 0)})}var d=document.createElement("canvas");d.id=l.canvasId;var h=document.createElement("canvas");h.id=l.tmpCanvasId,angular.element(h).css({position:"absolute",top:0,left:0}),o.find("div").append(d),o.find("div").append(h);var p=d.getContext("2d"),v=h.getContext("2d"),f={x:0,y:0},m=[];d.width=h.width=l.width,d.height=h.height=l.height,p.fillStyle=l.backgroundColor,p.fillRect(0,0,d.width,d.height),v.globalAlpha=l.opacity,v.lineJoin=v.lineCap="round",v.lineWidth=10,v.strokeStyle=l.color,n.$watch("options.lineWidth",function(e){"string"==typeof e&&(e=parseInt(e,10)),e&&"number"==typeof e&&(v.lineWidth=l.lineWidth=e)}),n.$watch("options.color",function(e){e&&(v.strokeStyle=v.fillStyle=e)}),n.$watch("options.opacity",function(e){e&&(v.globalAlpha=e)});var g=function(e){var t=e.getBoundingClientRect();return{left:t.left,top:t.top}},y=function(e,n){if(a){var o=document.body,i=document.documentElement,r=Math.max(o.scrollHeight,o.offsetHeight,i.clientHeight,i.scrollHeight,i.offsetHeight),c=n.changedTouches[0].pageY-(r-t.innerHeight+g(n.target).top);e.x=n.changedTouches[0].pageX-g(n.target).left,e.y=c}else e.x=void 0!==n.offsetX?n.offsetX:n.layerX,e.y=void 0!==n.offsetY?n.offsetY:n.layerY},w=function(e){if(e&&(e.preventDefault(),y(f,e)),m.push({x:f.x,y:f.y}),3===m.length){var t=m[0];return v.beginPath(),v.arc(t.x,t.y,v.lineWidth/2,0,2*Math.PI,!0),v.fill(),v.closePath(),void 0}v.clearRect(0,0,h.width,h.height),v.beginPath(),v.moveTo(m[0].x,m[0].y);for(var n=1;n<m.length-2;n++){var o=(m[n].x+m[n+1].x)/2,a=(m[n].y+m[n+1].y)/2;v.quadraticCurveTo(m[n].x,m[n].y,o,a)}v.quadraticCurveTo(m[n].x,m[n].y,m[n+1].x,m[n+1].y),v.stroke()},C=function(){l.undo&&n.$apply(function(){u.push(p.getImageData(0,0,h.width,h.height)),angular.isNumber(l.undo)&&l.undo>0&&(u=u.slice(-1*l.undo))}),h.removeEventListener(r,w,!1),p.drawImage(h,0,0),v.clearRect(0,0,h.width,h.height),m=[]},x=function(e){e.preventDefault(),h.addEventListener(r,w,!1),y(f,e),m.push({x:f.x,y:f.y}),m.push({x:f.x,y:f.y}),w()},b=function(){function e(){s=!0}function t(){s=!1}function o(){document.body.removeEventListener("mousedown",e),document.body.removeEventListener("mouseup",t)}function r(e){s&&x(e)}function l(e){s&&C(e)}if(h.addEventListener(i,x,!1),h.addEventListener(c,C,!1),!a){var s;document.body.addEventListener("mousedown",e),document.body.addEventListener("mouseup",t),n.$on("$destroy",o),h.addEventListener("mouseenter",r),h.addEventListener("mouseleave",l)}},E=function(e){u.length>0&&(p.putImageData(u[e],0,0),u=u.slice(0,e))};b()}}}]),angular.module("pw.canvas-painter").directive("pwColorSelector",function(){return{restrict:"AE",scope:{colorList:"=pwColorSelector",selectedColor:"=color"},templateUrl:"../templates/color-selector.html",link:function(e){e.setColor=function(t){e.selectedColor=t}}}})}(this);